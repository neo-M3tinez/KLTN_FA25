# ğŸ”„ Security Agent Workflow - Alert Processing Pipeline

## ğŸ“Š Overall Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸš¨ SECURITY ALERT INPUT                          â”‚
â”‚  Kibana Alert: ModSecurity High Severity tá»« IP 196.251.86.122          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘  PLANNER AGENT - PhÃ¢n tÃ­ch & lá»±a chá»n playbook                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  INPUT:                                                                  â”‚
â”‚    â€¢ Alert metadata: rule.name, severity, timestamp                     â”‚
â”‚    â€¢ Alert content: transaction.client_ip, request.uri                  â”‚
â”‚                                                                          â”‚
â”‚  PROCESS:                                                                â”‚
â”‚    âœ“ PhÃ¢n tÃ­ch loáº¡i táº¥n cÃ´ng tá»« rule name                               â”‚
â”‚    âœ“ Extract IOCs (IPs, URLs, domains)                                  â”‚
â”‚    âœ“ Match vá»›i playbook database                                        â”‚
â”‚                                                                          â”‚
â”‚  OUTPUT:                                                                 â”‚
â”‚    âœ“ Selected Playbook: "Web Application Attack Response"              â”‚
â”‚    âœ“ Confidence: 16.67%                                                 â”‚
â”‚    âœ“ IOCs Found: ["196.251.86.122", "/_profiler/phpinfo"]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¡ THREAT INTELLIGENCE AGENT - Tra cá»©u reputation                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  INPUT:                                                                  â”‚
â”‚    â€¢ IPs to check: ["196.251.86.122"]                                   â”‚
â”‚                                                                          â”‚
â”‚  PROCESS:                                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚    â”‚  AbuseIPDB API     â”‚â”€â”€â†’ GET https://api.abuseipdb.com/api/v2/checkâ”‚
â”‚    â”‚  API Key: 43b08... â”‚    Parameters: ip=196.251.86.122             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    Response: abuseConfidenceScore=100%       â”‚
â”‚             â”‚                                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚    â”‚  VirusTotal API    â”‚â”€â”€â†’ GET https://www.virustotal.com/api/v3/... â”‚
â”‚    â”‚  API Key: 8c2d0... â”‚    Parameters: ip=196.251.86.122             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    Response: malicious=15/90 vendors         â”‚
â”‚             â”‚                                                            â”‚
â”‚             â–¼                                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â”‚  Verdict Logic:                                      â”‚             â”‚
â”‚    â”‚  â€¢ AbuseIPDB Score â‰¥ 80 â†’ MALICIOUS                 â”‚             â”‚
â”‚    â”‚  â€¢ VirusTotal malicious â‰¥ 5 â†’ MALICIOUS             â”‚             â”‚
â”‚    â”‚  â€¢ AbuseIPDB Score 50-79 â†’ SUSPICIOUS                â”‚             â”‚
â”‚    â”‚  â€¢ VirusTotal malicious 1-4 â†’ SUSPICIOUS             â”‚             â”‚
â”‚    â”‚  â€¢ Else â†’ CLEAN                                      â”‚             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                          â”‚
â”‚  OUTPUT:                                                                 â”‚
â”‚    âœ“ IP: 196.251.86.122                                                 â”‚
â”‚      â”œâ”€ Verdict: MALICIOUS ğŸš«                                           â”‚
â”‚      â”œâ”€ AbuseIPDB: 100% abuse confidence                                â”‚
â”‚      â”œâ”€ VirusTotal: 15/90 vendors flagged                               â”‚
â”‚      â””â”€ Last Seen: Active in last 24h                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¢ SIEM FORENSIC AGENT - Thu tháº­p báº±ng chá»©ng                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  INPUT:                                                                  â”‚
â”‚    â€¢ Playbook queries: 4 queries (source.ip, user_agent, ...)          â”‚
â”‚    â€¢ WAF detection: YES (ModSecurity in alert)                          â”‚
â”‚    â€¢ Source IP: 196.251.86.122                                          â”‚
â”‚                                                                          â”‚
â”‚  PROCESS:                                                                â”‚
â”‚    A. PLAYBOOK QUERIES (Generic SIEM fields):                           â”‚
â”‚       Query 1: source.ip:196.251.86.122 â†’ âŒ 0 hits                     â”‚
â”‚       Query 2: user_agent:* AND source.ip:196.251.86.122 â†’ âŒ 0 hits    â”‚
â”‚       Query 3: event.category:network â†’ âŒ 0 hits                       â”‚
â”‚       Query 4: event.outcome:failure â†’ âŒ 0 hits                        â”‚
â”‚                                                                          â”‚
â”‚    B. WAF CONTEXT QUERIES (ModSecurity-specific fields):                â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â”‚ Query 1: transaction.client_ip:196.251.86.122      â”‚           â”‚
â”‚       â”‚ Timerange: 24h, Size: 30                           â”‚           â”‚
â”‚       â”‚ Target: Kibana Data View (filebeat-8.19.4)         â”‚           â”‚
â”‚       â”‚                                                     â”‚           â”‚
â”‚       â”‚ GET https://10.8.0.13:9200/filebeat-8.19.4/_searchâ”‚           â”‚
â”‚       â”‚ {                                                   â”‚           â”‚
â”‚       â”‚   "query": {                                        â”‚           â”‚
â”‚       â”‚     "bool": {                                       â”‚           â”‚
â”‚       â”‚       "must": [                                     â”‚           â”‚
â”‚       â”‚         {"term": {"transaction.client_ip": "..."}},â”‚           â”‚
â”‚       â”‚         {"range": {"@timestamp": {...}}}           â”‚           â”‚
â”‚       â”‚       ]                                             â”‚           â”‚
â”‚       â”‚     }                                               â”‚           â”‚
â”‚       â”‚   }                                                 â”‚           â”‚
â”‚       â”‚ }                                                   â”‚           â”‚
â”‚       â”‚                                                     â”‚           â”‚
â”‚       â”‚ âœ“ Result: 1 event                                  â”‚           â”‚
â”‚       â”‚   â”œâ”€ URI: /_profiler/phpinfo                       â”‚           â”‚
â”‚       â”‚   â”œâ”€ Rule: 933150 (PHP Injection)                  â”‚           â”‚
â”‚       â”‚   â”œâ”€ HTTP Code: 502                                â”‚           â”‚
â”‚       â”‚   â””â”€ Timestamp: 2025-11-11T17:56:10Z               â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                          â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â”‚ Query 2: HTTP errors from WAF                      â”‚           â”‚
â”‚       â”‚ KQL: transaction.response.http_code:(403 OR 502)   â”‚           â”‚
â”‚       â”‚ Timerange: 1h                                       â”‚           â”‚
â”‚       â”‚                                                     â”‚           â”‚
â”‚       â”‚ âœ“ Result: 10 events                                â”‚           â”‚
â”‚       â”‚   â”œâ”€ 403 Forbidden: 6 events (.env, .git access)   â”‚           â”‚
â”‚       â”‚   â”œâ”€ 502 Bad Gateway: 4 events                     â”‚           â”‚
â”‚       â”‚   â””â”€ Pattern: Scanning activity detected           â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                          â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â”‚ Query 3: Recent WAF activity                       â”‚           â”‚
â”‚       â”‚ KQL: log_type:modsec                               â”‚           â”‚
â”‚       â”‚ Timerange: 15m, Size: 50                           â”‚           â”‚
â”‚       â”‚                                                     â”‚           â”‚
â”‚       â”‚ âœ“ Result: 0 events (no recent activity)            â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                          â”‚
â”‚  OUTPUT:                                                                 â”‚
â”‚    âœ“ Total Queries: 7 (4 playbook + 3 WAF context)                     â”‚
â”‚    âœ“ Events Found: 11 events                                            â”‚
â”‚    âœ“ WAF Context Enabled: YES                                           â”‚
â”‚    âœ“ Context Summary:                                                   â”‚
â”‚      â”œâ”€ Events from attacker IP: 1                                      â”‚
â”‚      â”œâ”€ Blocked requests: 10                                            â”‚
â”‚      â””â”€ Recent activity: 0                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘£ FORENSIC ANALYSIS AGENT (Gemini AI) - PhÃ¢n tÃ­ch sÃ¢u                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  INPUT:                                                                  â”‚
â”‚    â€¢ Alert data: Full Kibana alert JSON                                 â”‚
â”‚    â€¢ TI results: MALICIOUS verdict + scores                             â”‚
â”‚    â€¢ SIEM data: 11 WAF events                                           â”‚
â”‚    â€¢ Playbook context: Web attack response procedures                   â”‚
â”‚                                                                          â”‚
â”‚  PROCESS:                                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚    â”‚  Google Gemini API Call                              â”‚            â”‚
â”‚    â”‚  Model: gemini-2.5-flash                             â”‚            â”‚
â”‚    â”‚  Temperature: 0.0 (deterministic)                    â”‚            â”‚
â”‚    â”‚                                                       â”‚            â”‚
â”‚    â”‚  POST https://generativelanguage.googleapis.com/...  â”‚            â”‚
â”‚    â”‚  {                                                    â”‚            â”‚
â”‚    â”‚    "contents": [{                                     â”‚            â”‚
â”‚    â”‚      "parts": [{                                      â”‚            â”‚
â”‚    â”‚        "text": "Analyze this security alert..."      â”‚            â”‚
â”‚    â”‚      }]                                               â”‚            â”‚
â”‚    â”‚    }],                                                â”‚            â”‚
â”‚    â”‚    "generationConfig": {                              â”‚            â”‚
â”‚    â”‚      "temperature": 0.0,                              â”‚            â”‚
â”‚    â”‚      "candidateCount": 1                              â”‚            â”‚
â”‚    â”‚    }                                                  â”‚            â”‚
â”‚    â”‚  }                                                    â”‚            â”‚
â”‚    â”‚                                                       â”‚            â”‚
â”‚    â”‚  AI Analysis Logic:                                  â”‚            â”‚
â”‚    â”‚  1. Correlate TI data vá»›i SIEM events                â”‚            â”‚
â”‚    â”‚  2. Identify attack patterns tá»« WAF rules            â”‚            â”‚
â”‚    â”‚  3. Timeline reconstruction                          â”‚            â”‚
â”‚    â”‚  4. Extract IOCs                                     â”‚            â”‚
â”‚    â”‚  5. Assess severity & impact                         â”‚            â”‚
â”‚    â”‚  6. Generate recommendations                         â”‚            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                          â”‚
â”‚  OUTPUT (JSON Format):                                                  â”‚
â”‚    {                                                                     â”‚
â”‚      "key_findings": [                                                  â”‚
â”‚        "PHP Injection attempt targeting /_profiler/phpinfo",            â”‚
â”‚        "IP 196.251.86.122 confirmed MALICIOUS by TI",                   â”‚
â”‚        "6 previous blocked requests from same IP",                      â”‚
â”‚        "ModSecurity rules 933150, 920350, 949110 triggered"             â”‚
â”‚      ],                                                                  â”‚
â”‚      "attack_timeline": [                                               â”‚
â”‚        "2025-11-11T17:56:10Z: PHP injection attempt",                   â”‚
â”‚        "2025-11-11T17:56:45Z: Alert generated"                          â”‚
â”‚      ],                                                                  â”‚
â”‚      "web_attack_pattern": "Information Disclosure via phpinfo",        â”‚
â”‚      "attacker_behavior": "Reconnaissance & vulnerability scanning",    â”‚
â”‚      "iocs": [                                                          â”‚
â”‚        "IP: 196.251.86.122",                                            â”‚
â”‚        "URL: /_profiler/phpinfo",                                       â”‚
â”‚        "Method: GET"                                                    â”‚
â”‚      ],                                                                  â”‚
â”‚      "correlation_analysis": "TI confirms malicious IP...",             â”‚
â”‚      "recommended_actions": [...]                                       â”‚
â”‚    }                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¤ RESPONSE PLANNING AGENT - Láº­p káº¿ hoáº¡ch á»©ng phÃ³                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  INPUT:                                                                  â”‚
â”‚    â€¢ Analysis results: Findings, IOCs, timeline                         â”‚
â”‚    â€¢ Playbook actions: Predefined response procedures                   â”‚
â”‚    â€¢ Severity: HIGH (from alert)                                        â”‚
â”‚                                                                          â”‚
â”‚  PROCESS:                                                                â”‚
â”‚    âœ“ Map findings to response actions                                   â”‚
â”‚    âœ“ Prioritize by severity (critical â†’ high â†’ medium)                  â”‚
â”‚    âœ“ Tag automation capability ([AUTO] vs [MANUAL])                     â”‚
â”‚                                                                          â”‚
â”‚  OUTPUT:                                                                 â”‚
â”‚    [                                                                     â”‚
â”‚      "[AUTO] Block attacking IP at WAF (Priority: critical)",           â”‚
â”‚      "[AUTO] Review WAF logs for patterns (Priority: high)",            â”‚
â”‚      "[AUTO] Check app logs for exploits (Priority: critical)",         â”‚
â”‚      "[MANUAL] Verify database integrity (Priority: high)",             â”‚
â”‚      "[MANUAL] Review recent code changes (Priority: medium)"           â”‚
â”‚    ]                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¥ TELEGRAM NOTIFICATION AGENT - Gá»­i cáº£nh bÃ¡o                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  INPUT:                                                                  â”‚
â”‚    â€¢ Complete workflow result (all steps above)                         â”‚
â”‚    â€¢ Telegram config: bot_token, chat_id                                â”‚
â”‚                                                                          â”‚
â”‚  PROCESS:                                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚    â”‚  Message Formatting (HTML)                           â”‚            â”‚
â”‚    â”‚                                                       â”‚            â”‚
â”‚    â”‚  ğŸŸ  <b>SECURITY ALERT</b> ğŸŸ                          â”‚            â”‚
â”‚    â”‚                                                       â”‚            â”‚
â”‚    â”‚  <b>Rule:</b> modsecurity                            â”‚            â”‚
â”‚    â”‚  <b>Severity:</b> HIGH                               â”‚            â”‚
â”‚    â”‚  <b>Time:</b> 2025-11-11T17:56:45Z                   â”‚            â”‚
â”‚    â”‚  <b>Playbook:</b> Web Attack Response                â”‚            â”‚
â”‚    â”‚                                                       â”‚            â”‚
â”‚    â”‚  ğŸ” <b>Threat Intelligence:</b>                      â”‚            â”‚
â”‚    â”‚    ğŸš« <code>196.251.86.122</code> - MALICIOUS        â”‚            â”‚
â”‚    â”‚    â€¢ AbuseIPDB: 100% confidence                      â”‚            â”‚
â”‚    â”‚    â€¢ VirusTotal: 15/90 flagged                       â”‚            â”‚
â”‚    â”‚                                                       â”‚            â”‚
â”‚    â”‚  ğŸ›¡ï¸ <b>WAF Context:</b>                             â”‚            â”‚
â”‚    â”‚    â€¢ Events from attacker: <code>1</code>            â”‚            â”‚
â”‚    â”‚    â€¢ Blocked requests: <code>10</code>               â”‚            â”‚
â”‚    â”‚    â€¢ Recent activity: <code>0</code>                 â”‚            â”‚
â”‚    â”‚                                                       â”‚            â”‚
â”‚    â”‚  ğŸ“Š <b>Key Findings:</b>                             â”‚            â”‚
â”‚    â”‚    â€¢ PHP injection targeting phpinfo                 â”‚            â”‚
â”‚    â”‚    â€¢ 6 previous attacks from same IP                 â”‚            â”‚
â”‚    â”‚    â€¢ Scanning activity detected                      â”‚            â”‚
â”‚    â”‚                                                       â”‚            â”‚
â”‚    â”‚  âš”ï¸ <b>Attack Pattern:</b>                           â”‚            â”‚
â”‚    â”‚    Information disclosure via phpinfo                â”‚            â”‚
â”‚    â”‚                                                       â”‚            â”‚
â”‚    â”‚  ğŸ¯ <b>IOCs:</b>                                     â”‚            â”‚
â”‚    â”‚    â€¢ <code>IP: 196.251.86.122</code>                 â”‚            â”‚
â”‚    â”‚    â€¢ <code>URL: /_profiler/phpinfo</code>            â”‚            â”‚
â”‚    â”‚                                                       â”‚            â”‚
â”‚    â”‚  ğŸš¨ <b>Critical Actions:</b>                         â”‚            â”‚
â”‚    â”‚    â€¢ Block IP at firewall                            â”‚            â”‚
â”‚    â”‚    â€¢ Check application logs                          â”‚            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                          â”‚
â”‚    POST https://api.telegram.org/bot{token}/sendMessage                â”‚
â”‚    {                                                                     â”‚
â”‚      "chat_id": "-5040439554",                                          â”‚
â”‚      "text": "...",                                                     â”‚
â”‚      "parse_mode": "HTML",                                              â”‚
â”‚      "disable_web_page_preview": true                                   â”‚
â”‚    }                                                                     â”‚
â”‚                                                                          â”‚
â”‚  OUTPUT:                                                                 â”‚
â”‚    âœ… Message sent successfully to Telegram                             â”‚
â”‚    âœ… Security team notified                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¦ OUTPUT - LÆ°u káº¿t quáº£ & káº¿t thÃºc workflow                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  OUTPUTS:                                                                â”‚
â”‚    âœ“ workflow_result.json - Complete workflow result                    â”‚
â”‚    âœ“ Console logs - Real-time progress tracking                         â”‚
â”‚    âœ“ Telegram message - Security team notification                      â”‚
â”‚                                                                          â”‚
â”‚  WORKFLOW STATE:                                                         â”‚
â”‚    {                                                                     â”‚
â”‚      "playbook_selected": true,                                         â”‚
â”‚      "ti_checked": true,                                                â”‚
â”‚      "siem_investigated": true,                                         â”‚
â”‚      "analysis_completed": true,                                        â”‚
â”‚      "actions_planned": true,                                           â”‚
â”‚      "notification_sent": true                                          â”‚
â”‚    }                                                                     â”‚
â”‚                                                                          â”‚
â”‚  âœ… WORKFLOW COMPLETE                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ Key Points

### Data Flow
```
Kibana Alert â†’ Planner â†’ TI Check â†’ SIEM Queries â†’ AI Analysis â†’ Response Plan â†’ Telegram
     â”‚            â”‚          â”‚           â”‚              â”‚              â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              All data flows to workflow_result.json
```

### External APIs Used
1. **AbuseIPDB**: IP reputation check (100% confidence)
2. **VirusTotal**: Multi-vendor threat intelligence (15/90 vendors)
3. **Elasticsearch**: SIEM data queries (11 events)
4. **Gemini AI**: Deep analysis & correlation
5. **Telegram**: Team notification delivery

### Routing Logic
```
START â†’ planner_agent
      â†“
      check if playbook_selected == null â†’ YES â†’ planner_agent
                                         â†’ NO  â†’ check ti_checked
      â†“
      check if ti_checked == null â†’ YES â†’ ti_agent
                                  â†’ NO  â†’ check siem_investigated
      â†“
      check if siem_investigated == null â†’ YES â†’ forensic_agent
                                         â†’ NO  â†’ check analysis_completed
      â†“
      check if analysis_completed == null â†’ YES â†’ forensic_agent (analysis)
                                          â†’ NO  â†’ check actions_taken
      â†“
      check if actions_taken == null â†’ YES â†’ response_agent
                                     â†’ NO  â†’ check notification_sent
      â†“
      check if notification_sent == null â†’ YES â†’ notification_agent
                                         â†’ NO  â†’ END
```

### Performance Metrics
- **Total Execution Time**: ~15-20 seconds
- **API Calls**: 
  - Kibana: 4 queries (3 WAF context + 1 data view)
  - AbuseIPDB: 1 request
  - VirusTotal: 1 request
  - Gemini: 1 request
  - Telegram: 1 request
- **Events Processed**: 11 WAF events
- **IOCs Extracted**: 3 indicators

